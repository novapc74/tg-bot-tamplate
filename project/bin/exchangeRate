#!/usr/bin/env php
<?php

use App\Services\HttpClient\Dto\RubUsdtCurrencyDto;
use App\Services\HttpClient\Dto\TopCryptoCurrencyDto;
use App\Services\HttpClient\Client\ApiCoinGeckoClient;
use App\Services\HttpClient\Dto\RubUsdtChange24hrCurrencyDto;

if (!file_exists($bootstrap = __DIR__ . '/../config/bootstrap.php')) {
    exit('Bootstrap file not found.');
}

require_once $bootstrap;

global $container;

$high = 'ðŸ“ˆ ';
$low = 'ðŸ“‰ ';

/** @var ApiCoinGeckoClient $client */
$client = $container->get(ApiCoinGeckoClient::class);

$response = $client->request(TopCryptoCurrencyDto::init());

if (!$data = $response?->getData()) {
    exit("Empty currency data, try later.\n");
}

$topCryptoCurrencies = [];
$maxLengthSymbol = $maxLengthPrice = $maxLengthPercent = 0;

/** Ñ„Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ Ð¼Ð°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½ÑƒÑŽ Ð´Ð»Ð¸Ð½Ñƒ ÑÑ‚Ñ€Ð¾Ðº Ð´Ð»Ñ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ñ, Ñ†ÐµÐ½Ñ‹ Ð¸ Ð¿Ñ€Ð¾Ñ†ÐµÐ½Ñ‚Ð¾Ð² */
foreach ($data as &$currency) {
    $maxLengthPrice = max([$maxLengthPrice, strlen($currency['current_price'])]);
    $maxLengthPercent = max([$maxLengthPercent, strlen($currency['price_change_percentage_24h'])]);
    $currency['symbol'] = strtoupper($currency['symbol'] . '/USD:');
    $maxLengthSymbol = max([$maxLengthSymbol, strlen($currency['symbol'])]);
}

$result = [];

/** Ñ„Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ Ð¸Ñ‚Ð¾Ð³Ð¾Ð²Ñ‹Ð¹ Ð¼Ð°ÑÑÐ¸Ð² Ð´Ð»Ñ Ñ‚Ð¾Ð¿-5 Ð²Ð°Ð»ÑŽÑ‚ */
foreach ($data as &$currency) {
    $price = mb_str_pad($currency['current_price'], $maxLengthPrice, ' ', STR_PAD_LEFT);
    $priceChangePercentage = mb_str_pad($currency['price_change_percentage_24h'], $maxLengthPercent, ' ', STR_PAD_LEFT) . '%';
    $symbol = mb_str_pad($currency['symbol'], $maxLengthSymbol, ' ', 1);
    $rowType = $currency['price_change_percentage_24h'] >= 0 ? $high : $low;
    $result[] = "$symbol $price $rowType $priceChangePercentage";
}

$result[] = str_repeat('=', strlen($result[1]) - 2);

/** Ñ„Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ Ð¾Ñ‚Ð½Ð¾ÑˆÐµÐ½Ð¸Ðµ RUB/USDT Ð¿Ð¾ ÑˆÐ°Ð±Ð»Ð¾Ð½Ñƒ Ð²Ð°Ð»ÑŽÑ‚ */
$response = $client->request(RubUsdtCurrencyDto::init());
$data = $response->getData();
$rubToUsdt = $data['tether']['rub'];

$response = $client->request(RubUsdtChange24hrCurrencyDto::init());
$data = $response->getData();

$priceChangePercent = ($data['prices'][1][1] - $data['prices'][0][1]) / $data['prices'][0][1] * 100;
$rubToUsdt_Change24hr = number_format($priceChangePercent, 2, '.', '');

$rowType = $rubToUsdt_Change24hr >= 0 ? $high : $low;
$price = mb_str_pad($rubToUsdt, $maxLengthPrice, ' ', STR_PAD_LEFT);
$priceChangePercentage = mb_str_pad($rubToUsdt_Change24hr, $maxLengthPercent, ' ', STR_PAD_LEFT) . '%';
$symbol = mb_str_pad('RUB/USDT:', $maxLengthSymbol, ' ', 1);

/** Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ñ€ÑƒÐ±Ð»Ð¸ Ð² ÐºÐ¾Ð½ÐµÑ† Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹ */
$result[] = "$symbol $price $rowType $priceChangePercentage";

/** ÑˆÐ°Ð¿ÐºÐ° Ð´Ð»Ñ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹ */
array_unshift($result, "```\nðŸ’¸ ÐšÑƒÑ€ÑÑ‹ Ð²Ð°Ð»ÑŽÑ‚ Ð¸ ÐºÑ€Ð¸Ð¿Ñ‚Ð¾Ð²Ð°Ð»ÑŽÑ‚");

$fileContent =  implode("\n", $result) . "\n```";

$filePath = \App\Enum\FileHelper::CRYPTO_PRICE_FILE_PATH->value;
file_put_contents($filePath, $fileContent);

exit();
